name: Initialization procedure

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  install-dist-subrepo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install git-subrepo
        shell: bash
        run: |
          git clone https://github.com/ingydotnet/git-subrepo ~/.git-subrepo
          echo "$HOME/.git-subrepo/lib" >> "$GITHUB_PATH"

      - name: Check git-subrepo installation
        shell: bash
        run: git subrepo --version

      - name: Configure git identity for commits
        shell: bash
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"

      - name: Create dist subrepo clone
        shell: bash
        run: |
          set -euo pipefail
          ORIGIN_URL="$(git remote get-url origin 2>/dev/null || true)"
          if [[ -z "$ORIGIN_URL" ]]; then
            echo "Error: could not find 'origin' remote URL." >&2
            exit 1
          fi

          if [[ -d "dist" && -n "$(ls -A dist 2>/dev/null)" ]]; then
            echo "Error: './dist' already exists and is not empty. Remove it or choose another directory before running." >&2
            exit 1
          fi

          git subrepo clone --branch=dist "$ORIGIN_URL" dist
          echo "Pushing 'main'..."
          git push -u origin main
      - name: Install node
        uses: actions/setup-node@v6
        with:
          node-version: 24
      - name: Remove checklist from README
        run: npx @p-buddy/parkdown --file ./README.md --depopulate --no-inclusions
      - name: Populate README with installation details
        shell: bash
        run: |
          bash -c "$(curl -fsSL https://raw.githubusercontent.com/pmalacho-mit/subrepo-dependency-management/refs/heads/main/scripts/populate-readme-after-init.sh)"
      - name: Commit and push updated README
        shell: bash
        run: |
          set -euo pipefail
          if [[ -n "$(git status --porcelain README.md)" ]]; then
            git add README.md
            git commit -m "chore: update README after initialization"
            git push
          else
            echo "No changes to README.md to commit."
          fi
      - name: Mark repo as initialized
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO:  ${{ github.event.repository.name }}
        run: |
          curl -sSf -X PUT \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$OWNER/$REPO/actions/variables/SUEDE_INIT \
            -d '{"name":"SUEDE_INIT","value":"true"}'
